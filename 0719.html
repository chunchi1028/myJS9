<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>æˆ‘çš„æ‰‹å¸³</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- å­—é«” -->
    <link
      href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&family=Cute+Font&family=Indie+Flower&display=swap"
      rel="stylesheet"
    />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Cute Font", sans-serif;
        background-color: #f8f4ef;
      }
      header {
        padding: 10px;
        background-color: #ffeedf;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        border-bottom: 2px dashed #cfa;
      }
      #controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        justify-content: center;
      }
      select,
      button,
      input[type="file"],
      input[type="date"] {
        font-size: 14px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      #journal {
        position: relative;
        min-height: 500px;
        padding: 20px;
        margin: 10px;
        border-radius: 10px;
        background-size: cover;
        background-position: center;
        background-image: url("https://i.imgur.com/bPq5uQt.png"); /* åˆå§‹ç‚ºç‰›çš®ç´™ */
      }
      textarea {
        width: 100%;
        min-height: 200px;
        padding: 10px;
        font-size: 18px;
        resize: none;
        border-radius: 8px;
        font-family: "Zhi Mang Xing", cursive;
      }
      .sticker {
        position: absolute;
        width: 80px;
        cursor: move;
      }
      #sticker-box {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 10px;
        background: #fff7f0;
        border-top: 1px dashed #ccc;
      }
      #sticker-box img {
        width: 60px;
        cursor: grab;
      }
      @media (max-width: 600px) {
        textarea {
          font-size: 16px;
        }
        #journal {
          margin: 5px;
        }
      }
    </style>
  </head>
  <body>
    <header>æˆ‘çš„æ‰‹å¸³</header>

    <div id="controls">
      <input type="date" id="datePicker" />
      <select id="fontPicker">
        <option value="'Zhi Mang Xing', cursive">è„‚ç­†è¡Œï¼ˆä¸­å¼æ‰‹å¯«ï¼‰</option>
        <option value="'Cute Font', cursive">å¯æ„›å­—é«”</option>
        <option value="'Indie Flower', cursive">è‹±æ–‡æ‰‹å¯«</option>
      </select>
      <select id="bgPicker">
        <option value="https://i.imgur.com/bPq5uQt.png">ç‰›çš®ç´™</option>
        <option value="https://i.imgur.com/KLzkNBz.png">æ ¼ç´‹ç´™</option>
        <option value="https://i.imgur.com/HWGuVuo.png">é»é™£ç´™</option>
      </select>
      <input type="file" id="upload" accept="image/*" />
      <button onclick="saveJournal()">ğŸ’¾ å„²å­˜</button>
      <button onclick="exportAsImage()">ğŸ“¸ åŒ¯å‡º</button>
      <button onclick="clearJournal()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    <div id="journal" ondrop="drop(event)" ondragover="allowDrop(event)">
      <textarea id="text-area" placeholder="ä»Šå¤©çš„å¿ƒæƒ…å¯«é€™è£¡..."></textarea>
    </div>

    <div id="sticker-box">
      <!-- éƒµç¥¨è²¼ç´™ -->
      <img
        src="https://i.imgur.com/mkTH1N2.png"
        draggable="true"
        ondragstart="drag(event)"
      />
      <img
        src="https://i.imgur.com/MDegjsE.png"
        draggable="true"
        ondragstart="drag(event)"
      />
      <!-- å°ç« è²¼ç´™ -->
      <img
        src="https://i.imgur.com/IxVJQO5.png"
        draggable="true"
        ondragstart="drag(event)"
      />
      <img
        src="https://i.imgur.com/DJ0sAEk.png"
        draggable="true"
        ondragstart="drag(event)"
      />
    </div>

    <script>
      let draggedImage = null;

      function drag(ev) {
        draggedImage = ev.target.src;
      }
      function allowDrop(ev) {
        ev.preventDefault();
      }
      function drop(ev) {
        ev.preventDefault();
        if (draggedImage) {
          const img = document.createElement("img");
          img.src = draggedImage;
          img.className = "sticker";
          img.style.left = ev.offsetX + "px";
          img.style.top = ev.offsetY + "px";
          makeDraggable(img);
          document.getElementById("journal").appendChild(img);
        }
      }
      function makeDraggable(el) {
        let isDragging = false,
          offsetX = 0,
          offsetY = 0;

        el.addEventListener("mousedown", (e) => {
          isDragging = true;
          offsetX = e.offsetX;
          offsetY = e.offsetY;
        });
        el.addEventListener("touchstart", (e) => {
          isDragging = true;
          const touch = e.touches[0];
          offsetX = touch.clientX - el.offsetLeft;
          offsetY = touch.clientY - el.offsetTop;
        });
        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            el.style.left = e.pageX - offsetX + "px";
            el.style.top = e.pageY - offsetY + "px";
          }
        });
        document.addEventListener("touchmove", (e) => {
          if (isDragging) {
            const touch = e.touches[0];
            el.style.left = touch.clientX - offsetX + "px";
            el.style.top = touch.clientY - offsetY + "px";
          }
        });
        document.addEventListener("mouseup", () => (isDragging = false));
        document.addEventListener("touchend", () => (isDragging = false));
      }

      function getKey(keyType) {
        const date = document.getElementById("datePicker").value || "default";
        return keyType + "_" + date;
      }

      function saveJournal() {
        const text = document.getElementById("text-area").value;
        const stickers = [...document.querySelectorAll(".sticker")].map(
          (img) => ({
            src: img.src,
            left: img.style.left,
            top: img.style.top,
          })
        );
        localStorage.setItem(getKey("text"), text);
        localStorage.setItem(getKey("stickers"), JSON.stringify(stickers));
        alert("âœ… å·²å„²å­˜");
      }

      function loadJournal() {
        document.querySelectorAll(".sticker").forEach((el) => el.remove());
        const savedText = localStorage.getItem(getKey("text"));
        const savedStickers = JSON.parse(
          localStorage.getItem(getKey("stickers")) || "[]"
        );
        document.getElementById("text-area").value = savedText || "";
        for (const s of savedStickers) {
          const img = document.createElement("img");
          img.src = s.src;
          img.className = "sticker";
          img.style.left = s.left;
          img.style.top = s.top;
          makeDraggable(img);
          document.getElementById("journal").appendChild(img);
        }
      }

      function clearJournal() {
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºé€™é å—ï¼Ÿ")) {
          document.getElementById("text-area").value = "";
          document.querySelectorAll(".sticker").forEach((s) => s.remove());
          localStorage.removeItem(getKey("text"));
          localStorage.removeItem(getKey("stickers"));
        }
      }

      function exportAsImage() {
        html2canvas(document.getElementById("journal")).then((canvas) => {
          const link = document.createElement("a");
          link.download = "journal.png";
          link.href = canvas.toDataURL();
          link.click();
        });
      }

      document.getElementById("fontPicker").addEventListener("change", (e) => {
        document.getElementById("text-area").style.fontFamily = e.target.value;
      });

      document.getElementById("bgPicker").addEventListener("change", (e) => {
        document.getElementById(
          "journal"
        ).style.backgroundImage = `url('${e.target.value}')`;
      });

      document
        .getElementById("upload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (evt) {
            const img = document.createElement("img");
            img.src = evt.target.result;
            img.className = "sticker";
            img.style.left = "100px";
            img.style.top = "100px";
            makeDraggable(img);
            document.getElementById("journal").appendChild(img);
          };
          reader.readAsDataURL(file);
        });

      document
        .getElementById("datePicker")
        .addEventListener("change", loadJournal);
      window.onload = () => {
        document.getElementById("datePicker").valueAsDate = new Date();
        loadJournal();
      };
    </script>
  </body>
</html>
